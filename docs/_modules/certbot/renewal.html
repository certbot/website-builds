

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>certbot.renewal &mdash; Certbot 0.31.0.dev0 documentation</title>
  
<!--

 ██████╗███████╗██████╗ ████████╗██████╗  ██████╗ ████████╗
██╔════╝██╔════╝██╔══██╗╚══██╔══╝██╔══██╗██╔═══██╗╚══██╔══╝
██║     █████╗  ██████╔╝   ██║   ██████╔╝██║   ██║   ██║
██║     ██╔══╝  ██╔══██╗   ██║   ██╔══██╗██║   ██║   ██║
╚██████╗███████╗██║  ██║   ██║   ██████╔╝╚██████╔╝   ██║
 ╚═════╝╚══════╝╚═╝  ╚═╝   ╚═╝   ╚═════╝  ╚═════╝    ╚═╝

Like looking at code? Help us! https://github.com/certbot/certbot
-->

  
  

  <meta name="description" content="Automatically enable HTTPS on your website with EFF's Certbot, deploying Let's Encrypt certificates.">
<meta property="og:image" content="https://certbot.eff.org/images/certbot-OG.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@EFF">
<meta name="twitter:title" content="certbot.renewal &mdash; Certbot 0.31.0.dev0 documentation">
<meta name="twitter:description" content="Automatically enable HTTPS on your website with EFF's Certbot, deploying Let's Encrypt certificates.">
<meta name="twitter:image" content="https://certbot.eff.org/images/certbot-OG.png">
<meta name="twitter:image:alt" content="Certbot: An automatic client for enabling HTTPS on your website.">

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="Certbot 0.31.0.dev0 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <nav class="main-nav fixed">
  <ul>
    <li><a href="/"><img src="/images/EFF-logo-plain.svg" alt="Electronic Frontier Foundation"></a></li>
    <li><a href="/">Home</a></li>
    <li><a href="/about/">About Certbot</a></li>
    <li><a href="/faq/">FAQ</a></li>
    <li><a href="/docs/">Documentation</a></li>
    <li><a href="/support/">Support</a></li>
    <li><a target="_blank" rel="noreferrer" href="https://github.com/certbot/certbot">Source Code</a></li>
    <li class="donate"><a target="_blank" href="https://supporters.eff.org/donate/support-work-on-certbot">donate to EFF</a></li>
    <li id="hamburger">&#x2261;</li>
  </ul>
</nav>

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../" class="icon icon-home"> Certbot
          

          
          </a>

          
            
            
              <div class="version">
                0.31
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../what.html">What is a Certificate?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Get Certbot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../using.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packaging.html">Packaging Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../resources.html">Resources</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../">Certbot</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          











<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
        <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>certbot.renewal</li>
    <li class="wy-breadcrumbs-aside">
      
        
          <a href="https://github.com/certbot/certbot/blob/master/docs/_modules/certbot/renewal" class="fa fa-github"> Edit on GitHub</a>
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for certbot.renewal</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Functionality for autorenewal and associated juggling of configurations&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">zope.component</span>

<span class="kn">import</span> <span class="nn">OpenSSL</span>

<span class="kn">from</span> <span class="nn">acme.magic_typing</span> <span class="k">import</span> <span class="n">List</span>  <span class="c1"># pylint: disable=unused-import, no-name-in-module</span>

<span class="kn">from</span> <span class="nn">certbot</span> <span class="k">import</span> <span class="n">cli</span>
<span class="kn">from</span> <span class="nn">certbot</span> <span class="k">import</span> <span class="n">crypto_util</span>
<span class="kn">from</span> <span class="nn">certbot</span> <span class="k">import</span> <span class="n">errors</span>
<span class="kn">from</span> <span class="nn">certbot</span> <span class="k">import</span> <span class="n">interfaces</span>
<span class="kn">from</span> <span class="nn">certbot</span> <span class="k">import</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">certbot</span> <span class="k">import</span> <span class="n">hooks</span>
<span class="kn">from</span> <span class="nn">certbot</span> <span class="k">import</span> <span class="n">storage</span>
<span class="kn">from</span> <span class="nn">certbot</span> <span class="k">import</span> <span class="n">updater</span>

<span class="kn">from</span> <span class="nn">certbot.plugins</span> <span class="k">import</span> <span class="n">disco</span> <span class="k">as</span> <span class="n">plugins_disco</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># These are the items which get pulled out of a renewal configuration</span>
<span class="c1"># file&#39;s renewalparams and actually used in the client configuration</span>
<span class="c1"># during the renewal process. We have to record their types here because</span>
<span class="c1"># the renewal configuration process loses this information.</span>
<span class="n">STR_CONFIG_ITEMS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;config_dir&quot;</span><span class="p">,</span> <span class="s2">&quot;logs_dir&quot;</span><span class="p">,</span> <span class="s2">&quot;work_dir&quot;</span><span class="p">,</span> <span class="s2">&quot;user_agent&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;server&quot;</span><span class="p">,</span> <span class="s2">&quot;account&quot;</span><span class="p">,</span> <span class="s2">&quot;authenticator&quot;</span><span class="p">,</span> <span class="s2">&quot;installer&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;standalone_supported_challenges&quot;</span><span class="p">,</span> <span class="s2">&quot;renew_hook&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;pre_hook&quot;</span><span class="p">,</span> <span class="s2">&quot;post_hook&quot;</span><span class="p">,</span> <span class="s2">&quot;tls_sni_01_address&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;http01_address&quot;</span><span class="p">]</span>
<span class="n">INT_CONFIG_ITEMS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;rsa_key_size&quot;</span><span class="p">,</span> <span class="s2">&quot;tls_sni_01_port&quot;</span><span class="p">,</span> <span class="s2">&quot;http01_port&quot;</span><span class="p">]</span>
<span class="n">BOOL_CONFIG_ITEMS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;must_staple&quot;</span><span class="p">,</span> <span class="s2">&quot;allow_subset_of_names&quot;</span><span class="p">,</span> <span class="s2">&quot;reuse_key&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;autorenew&quot;</span><span class="p">]</span>

<span class="n">CONFIG_ITEMS</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span>
    <span class="n">BOOL_CONFIG_ITEMS</span><span class="p">,</span> <span class="n">INT_CONFIG_ITEMS</span><span class="p">,</span> <span class="n">STR_CONFIG_ITEMS</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;pref_challs&#39;</span><span class="p">,)))</span>


<div class="viewcode-block" id="_reconstitute"><a class="viewcode-back" href="../../api/renewal.html#certbot.renewal._reconstitute">[docs]</a><span class="k">def</span> <span class="nf">_reconstitute</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">full_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Try to instantiate a RenewableCert, updating config with relevant items.</span>

<span class="sd">    This is specifically for use in renewal and enforces several checks</span>
<span class="sd">    and policies to ensure that we can try to proceed with the renewal</span>
<span class="sd">    request. The config argument is modified by including relevant options</span>
<span class="sd">    read from the renewal configuration file.</span>

<span class="sd">    :param configuration.NamespaceConfig config: configuration for the</span>
<span class="sd">        current lineage</span>
<span class="sd">    :param str full_path: Absolute path to the configuration file that</span>
<span class="sd">        defines this lineage</span>

<span class="sd">    :returns: the RenewableCert object or None if a fatal error occurred</span>
<span class="sd">    :rtype: `storage.RenewableCert` or NoneType</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">renewal_candidate</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="n">RenewableCert</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">CertStorageError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Renewal configuration file </span><span class="si">%s</span><span class="s2"> is broken. Skipping.&quot;</span><span class="p">,</span> <span class="n">full_path</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Traceback was:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s2">&quot;renewalparams&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">renewal_candidate</span><span class="o">.</span><span class="n">configuration</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Renewal configuration file </span><span class="si">%s</span><span class="s2"> lacks &quot;</span>
                       <span class="s2">&quot;renewalparams. Skipping.&quot;</span><span class="p">,</span> <span class="n">full_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">renewalparams</span> <span class="o">=</span> <span class="n">renewal_candidate</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;renewalparams&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;authenticator&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">renewalparams</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Renewal configuration file </span><span class="si">%s</span><span class="s2"> does not specify &quot;</span>
                       <span class="s2">&quot;an authenticator. Skipping.&quot;</span><span class="p">,</span> <span class="n">full_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="c1"># Now restore specific values along with their data types, if</span>
    <span class="c1"># those elements are present.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">restore_required_config_elements</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">renewalparams</span><span class="p">)</span>
        <span class="n">_restore_plugin_configs</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">renewalparams</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">Error</span><span class="p">)</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;An error occurred while parsing </span><span class="si">%s</span><span class="s2">. The error was </span><span class="si">%s</span><span class="s2">. &quot;</span>
            <span class="s2">&quot;Skipping the file.&quot;</span><span class="p">,</span> <span class="n">full_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Traceback was:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">domains</span> <span class="o">=</span> <span class="p">[</span><span class="n">util</span><span class="o">.</span><span class="n">enforce_domain_sanity</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">renewal_candidate</span><span class="o">.</span><span class="n">names</span><span class="p">()]</span>
    <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">ConfigurationError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Renewal configuration file </span><span class="si">%s</span><span class="s2"> references a cert &quot;</span>
                       <span class="s2">&quot;that contains an invalid domain name. The problem &quot;</span>
                       <span class="s2">&quot;was: </span><span class="si">%s</span><span class="s2">. Skipping.&quot;</span><span class="p">,</span> <span class="n">full_path</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">renewal_candidate</span></div>


<div class="viewcode-block" id="_restore_webroot_config"><a class="viewcode-back" href="../../api/renewal.html#certbot.renewal._restore_webroot_config">[docs]</a><span class="k">def</span> <span class="nf">_restore_webroot_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">renewalparams</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    webroot_map is, uniquely, a dict, and the general-purpose configuration</span>
<span class="sd">    restoring logic is not able to correctly parse it from the serialized</span>
<span class="sd">    form.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;webroot_map&quot;</span> <span class="ow">in</span> <span class="n">renewalparams</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cli</span><span class="o">.</span><span class="n">set_by_cli</span><span class="p">(</span><span class="s2">&quot;webroot_map&quot;</span><span class="p">):</span>
            <span class="n">config</span><span class="o">.</span><span class="n">webroot_map</span> <span class="o">=</span> <span class="n">renewalparams</span><span class="p">[</span><span class="s2">&quot;webroot_map&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s2">&quot;webroot_path&quot;</span> <span class="ow">in</span> <span class="n">renewalparams</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ancient renewal conf file without webroot-map, restoring webroot-path&quot;</span><span class="p">)</span>
        <span class="n">wp</span> <span class="o">=</span> <span class="n">renewalparams</span><span class="p">[</span><span class="s2">&quot;webroot_path&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wp</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>  <span class="c1"># prior to 0.1.0, webroot_path was a string</span>
            <span class="n">wp</span> <span class="o">=</span> <span class="p">[</span><span class="n">wp</span><span class="p">]</span>
        <span class="n">config</span><span class="o">.</span><span class="n">webroot_path</span> <span class="o">=</span> <span class="n">wp</span></div>


<div class="viewcode-block" id="_restore_plugin_configs"><a class="viewcode-back" href="../../api/renewal.html#certbot.renewal._restore_plugin_configs">[docs]</a><span class="k">def</span> <span class="nf">_restore_plugin_configs</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">renewalparams</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets plugin specific values in config from renewalparams</span>

<span class="sd">    :param configuration.NamespaceConfig config: configuration for the</span>
<span class="sd">        current lineage</span>
<span class="sd">    :param configobj.Section renewalparams: Parameters from the renewal</span>
<span class="sd">        configuration file that defines this lineage</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Now use parser to get plugin-prefixed items with correct types</span>
    <span class="c1"># XXX: the current approach of extracting only prefixed items</span>
    <span class="c1">#      related to the actually-used installer and authenticator</span>
    <span class="c1">#      works as long as plugins don&#39;t need to read plugin-specific</span>
    <span class="c1">#      variables set by someone else (e.g., assuming Apache</span>
    <span class="c1">#      configurator doesn&#39;t need to read webroot_ variables).</span>
    <span class="c1"># Note: if a parameter that used to be defined in the parser is no</span>
    <span class="c1">#      longer defined, stored copies of that parameter will be</span>
    <span class="c1">#      deserialized as strings by this logic even if they were</span>
    <span class="c1">#      originally meant to be some other type.</span>
    <span class="n">plugin_prefixes</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[str]</span>
    <span class="k">if</span> <span class="n">renewalparams</span><span class="p">[</span><span class="s2">&quot;authenticator&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;webroot&quot;</span><span class="p">:</span>
        <span class="n">_restore_webroot_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">renewalparams</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plugin_prefixes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">renewalparams</span><span class="p">[</span><span class="s2">&quot;authenticator&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">renewalparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;installer&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plugin_prefixes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">renewalparams</span><span class="p">[</span><span class="s2">&quot;installer&quot;</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">plugin_prefix</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">plugin_prefixes</span><span class="p">):</span>
        <span class="n">plugin_prefix</span> <span class="o">=</span> <span class="n">plugin_prefix</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">config_item</span><span class="p">,</span> <span class="n">config_value</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">renewalparams</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">config_item</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">plugin_prefix</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cli</span><span class="o">.</span><span class="n">set_by_cli</span><span class="p">(</span><span class="n">config_item</span><span class="p">):</span>
                <span class="c1"># Values None, True, and False need to be treated specially,</span>
                <span class="c1"># As their types aren&#39;t handled correctly by configobj</span>
                <span class="k">if</span> <span class="n">config_value</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">,</span> <span class="s2">&quot;False&quot;</span><span class="p">):</span>
                    <span class="c1"># bool(&quot;False&quot;) == True</span>
                    <span class="c1"># pylint: disable=eval-used</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">config_item</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">config_value</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cast</span> <span class="o">=</span> <span class="n">cli</span><span class="o">.</span><span class="n">argparse_type</span><span class="p">(</span><span class="n">config_item</span><span class="p">)</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">config_item</span><span class="p">,</span> <span class="n">cast</span><span class="p">(</span><span class="n">config_value</span><span class="p">))</span></div>


<div class="viewcode-block" id="restore_required_config_elements"><a class="viewcode-back" href="../../api/renewal.html#certbot.renewal.restore_required_config_elements">[docs]</a><span class="k">def</span> <span class="nf">restore_required_config_elements</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">renewalparams</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets non-plugin specific values in config from renewalparams</span>

<span class="sd">    :param configuration.NamespaceConfig config: configuration for the</span>
<span class="sd">        current lineage</span>
<span class="sd">    :param configobj.Section renewalparams: parameters from the renewal</span>
<span class="sd">        configuration file that defines this lineage</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">required_items</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span>
        <span class="p">((</span><span class="s2">&quot;pref_challs&quot;</span><span class="p">,</span> <span class="n">_restore_pref_challs</span><span class="p">),),</span>
        <span class="n">six</span><span class="o">.</span><span class="n">moves</span><span class="o">.</span><span class="n">zip</span><span class="p">(</span><span class="n">BOOL_CONFIG_ITEMS</span><span class="p">,</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">_restore_bool</span><span class="p">)),</span>
        <span class="n">six</span><span class="o">.</span><span class="n">moves</span><span class="o">.</span><span class="n">zip</span><span class="p">(</span><span class="n">INT_CONFIG_ITEMS</span><span class="p">,</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">_restore_int</span><span class="p">)),</span>
        <span class="n">six</span><span class="o">.</span><span class="n">moves</span><span class="o">.</span><span class="n">zip</span><span class="p">(</span><span class="n">STR_CONFIG_ITEMS</span><span class="p">,</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">_restore_str</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">item_name</span><span class="p">,</span> <span class="n">restore_func</span> <span class="ow">in</span> <span class="n">required_items</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">item_name</span> <span class="ow">in</span> <span class="n">renewalparams</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cli</span><span class="o">.</span><span class="n">set_by_cli</span><span class="p">(</span><span class="n">item_name</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">restore_func</span><span class="p">(</span><span class="n">item_name</span><span class="p">,</span> <span class="n">renewalparams</span><span class="p">[</span><span class="n">item_name</span><span class="p">])</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">item_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="_restore_pref_challs"><a class="viewcode-back" href="../../api/renewal.html#certbot.renewal._restore_pref_challs">[docs]</a><span class="k">def</span> <span class="nf">_restore_pref_challs</span><span class="p">(</span><span class="n">unused_name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Restores preferred challenges from a renewal config file.</span>

<span class="sd">    If value is a `str`, it should be a single challenge type.</span>

<span class="sd">    :param str unused_name: option name</span>
<span class="sd">    :param value: option value</span>
<span class="sd">    :type value: `list` of `str` or `str`</span>

<span class="sd">    :returns: converted option value to be stored in the runtime config</span>
<span class="sd">    :rtype: `list` of `str`</span>

<span class="sd">    :raises errors.Error: if value can&#39;t be converted to an bool</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If pref_challs has only one element, configobj saves the value</span>
    <span class="c1"># with a trailing comma so it&#39;s parsed as a list. If this comma is</span>
    <span class="c1"># removed by the user, the value is parsed as a str.</span>
    <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="k">else</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">cli</span><span class="o">.</span><span class="n">parse_preferred_challenges</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="_restore_bool"><a class="viewcode-back" href="../../api/renewal.html#certbot.renewal._restore_bool">[docs]</a><span class="k">def</span> <span class="nf">_restore_bool</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Restores an boolean key-value pair from a renewal config file.</span>

<span class="sd">    :param str name: option name</span>
<span class="sd">    :param str value: option value</span>

<span class="sd">    :returns: converted option value to be stored in the runtime config</span>
<span class="sd">    :rtype: bool</span>

<span class="sd">    :raises errors.Error: if value can&#39;t be converted to an bool</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lowercase_value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">lowercase_value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span>
            <span class="s2">&quot;Expected True or False for </span><span class="si">{0}</span><span class="s2"> but found </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">lowercase_value</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span></div>


<div class="viewcode-block" id="_restore_int"><a class="viewcode-back" href="../../api/renewal.html#certbot.renewal._restore_int">[docs]</a><span class="k">def</span> <span class="nf">_restore_int</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Restores an integer key-value pair from a renewal config file.</span>

<span class="sd">    :param str name: option name</span>
<span class="sd">    :param str value: option value</span>

<span class="sd">    :returns: converted option value to be stored in the runtime config</span>
<span class="sd">    :rtype: int</span>

<span class="sd">    :raises errors.Error: if value can&#39;t be converted to an int</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;http01_port&quot;</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;updating legacy http01_port value&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cli</span><span class="o">.</span><span class="n">flag_default</span><span class="p">(</span><span class="s2">&quot;http01_port&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Expected a numeric value for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span></div>


<div class="viewcode-block" id="_restore_str"><a class="viewcode-back" href="../../api/renewal.html#certbot.renewal._restore_str">[docs]</a><span class="k">def</span> <span class="nf">_restore_str</span><span class="p">(</span><span class="n">unused_name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Restores an string key-value pair from a renewal config file.</span>

<span class="sd">    :param str unused_name: option name</span>
<span class="sd">    :param str value: option value</span>

<span class="sd">    :returns: converted option value to be stored in the runtime config</span>
<span class="sd">    :rtype: str or None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span> <span class="k">else</span> <span class="n">value</span></div>


<div class="viewcode-block" id="should_renew"><a class="viewcode-back" href="../../api/renewal.html#certbot.renewal.should_renew">[docs]</a><span class="k">def</span> <span class="nf">should_renew</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">lineage</span><span class="p">):</span>
    <span class="s2">&quot;Return true if any of the circumstances for automatic renewal apply.&quot;</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">renew_by_default</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Auto-renewal forced with --force-renewal...&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">lineage</span><span class="o">.</span><span class="n">should_autorenew</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cert is due for renewal, auto-renewing...&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cert not due for renewal, but simulating renewal for dry run&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cert not yet due for renewal&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="_avoid_invalidating_lineage"><a class="viewcode-back" href="../../api/renewal.html#certbot.renewal._avoid_invalidating_lineage">[docs]</a><span class="k">def</span> <span class="nf">_avoid_invalidating_lineage</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">lineage</span><span class="p">,</span> <span class="n">original_server</span><span class="p">):</span>
    <span class="s2">&quot;Do not renew a valid cert with one from a staging server!&quot;</span>
    <span class="c1"># Some lineages may have begun with --staging, but then had production certs</span>
    <span class="c1"># added to them</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lineage</span><span class="o">.</span><span class="n">cert</span><span class="p">)</span> <span class="k">as</span> <span class="n">the_file</span><span class="p">:</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">the_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">latest_cert</span> <span class="o">=</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">load_certificate</span><span class="p">(</span>
        <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">contents</span><span class="p">)</span>
    <span class="c1"># all our test certs are from happy hacker fake CA, though maybe one day</span>
    <span class="c1"># we should test more methodically</span>
    <span class="n">now_valid</span> <span class="o">=</span> <span class="s2">&quot;fake&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">repr</span><span class="p">(</span><span class="n">latest_cert</span><span class="o">.</span><span class="n">get_issuer</span><span class="p">())</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">util</span><span class="o">.</span><span class="n">is_staging</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">server</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">util</span><span class="o">.</span><span class="n">is_staging</span><span class="p">(</span><span class="n">original_server</span><span class="p">)</span> <span class="ow">or</span> <span class="n">now_valid</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">break_my_certs</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lineage</span><span class="o">.</span><span class="n">names</span><span class="p">())</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span>
                    <span class="s2">&quot;You&#39;ve asked to renew/replace a seemingly valid certificate with &quot;</span>
                    <span class="s2">&quot;a test certificate (domains: </span><span class="si">{0}</span><span class="s2">). We will not do that &quot;</span>
                    <span class="s2">&quot;unless you use the --break-my-certs flag!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">names</span><span class="p">))</span></div>


<div class="viewcode-block" id="renew_cert"><a class="viewcode-back" href="../../api/renewal.html#certbot.renewal.renew_cert">[docs]</a><span class="k">def</span> <span class="nf">renew_cert</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">domains</span><span class="p">,</span> <span class="n">le_client</span><span class="p">,</span> <span class="n">lineage</span><span class="p">):</span>
    <span class="s2">&quot;Renew a certificate lineage.&quot;</span>
    <span class="n">renewal_params</span> <span class="o">=</span> <span class="n">lineage</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;renewalparams&quot;</span><span class="p">]</span>
    <span class="n">original_server</span> <span class="o">=</span> <span class="n">renewal_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;server&quot;</span><span class="p">,</span> <span class="n">cli</span><span class="o">.</span><span class="n">flag_default</span><span class="p">(</span><span class="s2">&quot;server&quot;</span><span class="p">))</span>
    <span class="n">_avoid_invalidating_lineage</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">lineage</span><span class="p">,</span> <span class="n">original_server</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">domains</span><span class="p">:</span>
        <span class="n">domains</span> <span class="o">=</span> <span class="n">lineage</span><span class="o">.</span><span class="n">names</span><span class="p">()</span>
    <span class="c1"># The private key is the existing lineage private key if reuse_key is set.</span>
    <span class="c1"># Otherwise, generate a fresh private key by passing None.</span>
    <span class="n">new_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">lineage</span><span class="o">.</span><span class="n">privkey</span><span class="p">)</span> <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">reuse_key</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">new_cert</span><span class="p">,</span> <span class="n">new_chain</span><span class="p">,</span> <span class="n">new_key</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">le_client</span><span class="o">.</span><span class="n">obtain_certificate</span><span class="p">(</span><span class="n">domains</span><span class="p">,</span> <span class="n">new_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Dry run: skipping updating lineage at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">lineage</span><span class="o">.</span><span class="n">cert</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prior_version</span> <span class="o">=</span> <span class="n">lineage</span><span class="o">.</span><span class="n">latest_common_version</span><span class="p">()</span>
        <span class="c1"># TODO: Check return value of save_successor</span>
        <span class="n">lineage</span><span class="o">.</span><span class="n">save_successor</span><span class="p">(</span><span class="n">prior_version</span><span class="p">,</span> <span class="n">new_cert</span><span class="p">,</span> <span class="n">new_key</span><span class="o">.</span><span class="n">pem</span><span class="p">,</span> <span class="n">new_chain</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="n">lineage</span><span class="o">.</span><span class="n">update_all_links_to</span><span class="p">(</span><span class="n">lineage</span><span class="o">.</span><span class="n">latest_common_version</span><span class="p">())</span>

    <span class="n">hooks</span><span class="o">.</span><span class="n">renew_hook</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">domains</span><span class="p">,</span> <span class="n">lineage</span><span class="o">.</span><span class="n">live_dir</span><span class="p">)</span></div>


<div class="viewcode-block" id="report"><a class="viewcode-back" href="../../api/renewal.html#certbot.renewal.report">[docs]</a><span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="n">msgs</span><span class="p">,</span> <span class="n">category</span><span class="p">):</span>
    <span class="s2">&quot;Format a results report for a category of renewal outcomes&quot;</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;  &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">_renew_describe_results</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">renew_successes</span><span class="p">,</span> <span class="n">renew_failures</span><span class="p">,</span>
                            <span class="n">renew_skipped</span><span class="p">,</span> <span class="n">parse_failures</span><span class="p">):</span>

    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[str]</span>
    <span class="n">notify</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">append</span>
    <span class="n">disp</span> <span class="o">=</span> <span class="n">zope</span><span class="o">.</span><span class="n">component</span><span class="o">.</span><span class="n">getUtility</span><span class="p">(</span><span class="n">interfaces</span><span class="o">.</span><span class="n">IDisplay</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">notify_error</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Notify and log errors.&quot;&quot;&quot;</span>
        <span class="n">notify</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
        <span class="n">notify</span><span class="p">(</span><span class="s2">&quot;** DRY RUN: simulating &#39;certbot renew&#39; close to cert expiry&quot;</span><span class="p">)</span>
        <span class="n">notify</span><span class="p">(</span><span class="s2">&quot;**          (The test certificates below have not been saved.)&quot;</span><span class="p">)</span>
    <span class="n">notify</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">renew_skipped</span><span class="p">:</span>
        <span class="n">notify</span><span class="p">(</span><span class="s2">&quot;The following certs are not due for renewal yet:&quot;</span><span class="p">)</span>
        <span class="n">notify</span><span class="p">(</span><span class="n">report</span><span class="p">(</span><span class="n">renew_skipped</span><span class="p">,</span> <span class="s2">&quot;skipped&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">renew_successes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">renew_failures</span><span class="p">:</span>
        <span class="n">notify</span><span class="p">(</span><span class="s2">&quot;No renewals were attempted.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">pre_hook</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span>
                <span class="n">config</span><span class="o">.</span><span class="n">renew_hook</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">post_hook</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">notify</span><span class="p">(</span><span class="s2">&quot;No hooks were run.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">renew_successes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">renew_failures</span><span class="p">:</span>
        <span class="n">notify</span><span class="p">(</span><span class="s2">&quot;Congratulations, all renewals succeeded. The following certs &quot;</span>
               <span class="s2">&quot;have been renewed:&quot;</span><span class="p">)</span>
        <span class="n">notify</span><span class="p">(</span><span class="n">report</span><span class="p">(</span><span class="n">renew_successes</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">renew_failures</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">renew_successes</span><span class="p">:</span>
        <span class="n">notify_error</span><span class="p">(</span><span class="s2">&quot;All renewal attempts failed. The following certs could &quot;</span>
               <span class="s2">&quot;not be renewed:&quot;</span><span class="p">)</span>
        <span class="n">notify_error</span><span class="p">(</span><span class="n">report</span><span class="p">(</span><span class="n">renew_failures</span><span class="p">,</span> <span class="s2">&quot;failure&quot;</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">renew_failures</span> <span class="ow">and</span> <span class="n">renew_successes</span><span class="p">:</span>
        <span class="n">notify</span><span class="p">(</span><span class="s2">&quot;The following certs were successfully renewed:&quot;</span><span class="p">)</span>
        <span class="n">notify</span><span class="p">(</span><span class="n">report</span><span class="p">(</span><span class="n">renew_successes</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">notify_error</span><span class="p">(</span><span class="s2">&quot;The following certs could not be renewed:&quot;</span><span class="p">)</span>
        <span class="n">notify_error</span><span class="p">(</span><span class="n">report</span><span class="p">(</span><span class="n">renew_failures</span><span class="p">,</span> <span class="s2">&quot;failure&quot;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">parse_failures</span><span class="p">:</span>
        <span class="n">notify</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Additionally, the following renewal configurations &quot;</span>
               <span class="s2">&quot;were invalid: &quot;</span><span class="p">)</span>
        <span class="n">notify</span><span class="p">(</span><span class="n">report</span><span class="p">(</span><span class="n">parse_failures</span><span class="p">,</span> <span class="s2">&quot;parsefail&quot;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
        <span class="n">notify</span><span class="p">(</span><span class="s2">&quot;** DRY RUN: simulating &#39;certbot renew&#39; close to cert expiry&quot;</span><span class="p">)</span>
        <span class="n">notify</span><span class="p">(</span><span class="s2">&quot;**          (The test certificates above have not been saved.)&quot;</span><span class="p">)</span>

    <span class="n">disp</span><span class="o">.</span><span class="n">notification</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">),</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<div class="viewcode-block" id="handle_renewal_request"><a class="viewcode-back" href="../../api/renewal.html#certbot.renewal.handle_renewal_request">[docs]</a><span class="k">def</span> <span class="nf">handle_renewal_request</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>  <span class="c1"># pylint: disable=too-many-locals,too-many-branches,too-many-statements</span>
    <span class="sd">&quot;&quot;&quot;Examine each lineage; renew if due and report results&quot;&quot;&quot;</span>

    <span class="c1"># This is trivially False if config.domains is empty</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">domain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">webroot_map</span> <span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">domains</span><span class="p">):</span>
        <span class="c1"># If more plugins start using cli.add_domains,</span>
        <span class="c1"># we may want to only log a warning here</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Currently, the renew verb is capable of either &quot;</span>
                           <span class="s2">&quot;renewing all installed certificates that are due &quot;</span>
                           <span class="s2">&quot;to be renewed or renewing a single certificate specified &quot;</span>
                           <span class="s2">&quot;by its name. If you would like to renew specific &quot;</span>
                           <span class="s2">&quot;certificates by their domains, use the certonly command &quot;</span>
                           <span class="s2">&quot;instead. The renew verb may provide other options &quot;</span>
                           <span class="s2">&quot;for selecting certificates to renew in the future.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">certname</span><span class="p">:</span>
        <span class="n">conf_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">storage</span><span class="o">.</span><span class="n">renewal_file_for_certname</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">certname</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">conf_files</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="n">renewal_conf_files</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="n">renew_successes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">renew_failures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">renew_skipped</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">parse_failures</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Noninteractive renewals include a random delay in order to spread</span>
    <span class="c1"># out the load on the certificate authority servers, even if many</span>
    <span class="c1"># users all pick the same time for renewals.  This delay precedes</span>
    <span class="c1"># running any hooks, so that side effects of the hooks (such as</span>
    <span class="c1"># shutting down a web service) aren&#39;t prolonged unnecessarily.</span>
    <span class="n">apply_random_sleep</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">isatty</span><span class="p">()</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">random_sleep_on_renew</span>

    <span class="k">for</span> <span class="n">renewal_file</span> <span class="ow">in</span> <span class="n">conf_files</span><span class="p">:</span>
        <span class="n">disp</span> <span class="o">=</span> <span class="n">zope</span><span class="o">.</span><span class="n">component</span><span class="o">.</span><span class="n">getUtility</span><span class="p">(</span><span class="n">interfaces</span><span class="o">.</span><span class="n">IDisplay</span><span class="p">)</span>
        <span class="n">disp</span><span class="o">.</span><span class="n">notification</span><span class="p">(</span><span class="s2">&quot;Processing &quot;</span> <span class="o">+</span> <span class="n">renewal_file</span><span class="p">,</span> <span class="n">pause</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">lineage_config</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="n">lineagename</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="n">lineagename_for_filename</span><span class="p">(</span><span class="n">renewal_file</span><span class="p">)</span>

        <span class="c1"># Note that this modifies config (to add back the configuration</span>
        <span class="c1"># elements from within the renewal configuration file).</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">renewal_candidate</span> <span class="o">=</span> <span class="n">_reconstitute</span><span class="p">(</span><span class="n">lineage_config</span><span class="p">,</span> <span class="n">renewal_file</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Renewal configuration file </span><span class="si">%s</span><span class="s2"> (cert: </span><span class="si">%s</span><span class="s2">) &quot;</span>
                           <span class="s2">&quot;produced an unexpected error: </span><span class="si">%s</span><span class="s2">. Skipping.&quot;</span><span class="p">,</span>
                           <span class="n">renewal_file</span><span class="p">,</span> <span class="n">lineagename</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Traceback was:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">parse_failures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">renewal_file</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">renewal_candidate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">parse_failures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">renewal_file</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># XXX: ensure that each call here replaces the previous one</span>
                <span class="n">zope</span><span class="o">.</span><span class="n">component</span><span class="o">.</span><span class="n">provideUtility</span><span class="p">(</span><span class="n">lineage_config</span><span class="p">)</span>
                <span class="n">renewal_candidate</span><span class="o">.</span><span class="n">ensure_deployed</span><span class="p">()</span>
                <span class="kn">from</span> <span class="nn">certbot</span> <span class="k">import</span> <span class="n">main</span>
                <span class="n">plugins</span> <span class="o">=</span> <span class="n">plugins_disco</span><span class="o">.</span><span class="n">PluginsRegistry</span><span class="o">.</span><span class="n">find_all</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">should_renew</span><span class="p">(</span><span class="n">lineage_config</span><span class="p">,</span> <span class="n">renewal_candidate</span><span class="p">):</span>
                    <span class="c1"># Apply random sleep upon first renewal if needed</span>
                    <span class="k">if</span> <span class="n">apply_random_sleep</span><span class="p">:</span>
                        <span class="n">sleep_time</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Non-interactive renewal: random delay of </span><span class="si">%s</span><span class="s2"> seconds&quot;</span><span class="p">,</span>
                                    <span class="n">sleep_time</span><span class="p">)</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
                        <span class="c1"># We will sleep only once this day, folks.</span>
                        <span class="n">apply_random_sleep</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="c1"># domains have been restored into lineage_config by reconstitute</span>
                    <span class="c1"># but they&#39;re unnecessary anyway because renew_cert here</span>
                    <span class="c1"># will just grab them from the certificate</span>
                    <span class="c1"># we already know it&#39;s time to renew based on should_renew</span>
                    <span class="c1"># and we have a lineage in renewal_candidate</span>
                    <span class="n">main</span><span class="o">.</span><span class="n">renew_cert</span><span class="p">(</span><span class="n">lineage_config</span><span class="p">,</span> <span class="n">plugins</span><span class="p">,</span> <span class="n">renewal_candidate</span><span class="p">)</span>
                    <span class="n">renew_successes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">renewal_candidate</span><span class="o">.</span><span class="n">fullchain</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">expiry</span> <span class="o">=</span> <span class="n">crypto_util</span><span class="o">.</span><span class="n">notAfter</span><span class="p">(</span><span class="n">renewal_candidate</span><span class="o">.</span><span class="n">version</span><span class="p">(</span>
                        <span class="s2">&quot;cert&quot;</span><span class="p">,</span> <span class="n">renewal_candidate</span><span class="o">.</span><span class="n">latest_common_version</span><span class="p">()))</span>
                    <span class="n">renew_skipped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> expires on </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">renewal_candidate</span><span class="o">.</span><span class="n">fullchain</span><span class="p">,</span>
                                         <span class="n">expiry</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)))</span>
                <span class="c1"># Run updater interface methods</span>
                <span class="n">updater</span><span class="o">.</span><span class="n">run_generic_updaters</span><span class="p">(</span><span class="n">lineage_config</span><span class="p">,</span> <span class="n">renewal_candidate</span><span class="p">,</span>
                                             <span class="n">plugins</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
            <span class="c1"># obtain_cert (presumably) encountered an unanticipated problem.</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Attempting to renew cert (</span><span class="si">%s</span><span class="s2">) from </span><span class="si">%s</span><span class="s2"> produced an &quot;</span>
                           <span class="s2">&quot;unexpected error: </span><span class="si">%s</span><span class="s2">. Skipping.&quot;</span><span class="p">,</span> <span class="n">lineagename</span><span class="p">,</span>
                               <span class="n">renewal_file</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Traceback was:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">renew_failures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">renewal_candidate</span><span class="o">.</span><span class="n">fullchain</span><span class="p">)</span>

    <span class="c1"># Describe all the results</span>
    <span class="n">_renew_describe_results</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">renew_successes</span><span class="p">,</span> <span class="n">renew_failures</span><span class="p">,</span>
                            <span class="n">renew_skipped</span><span class="p">,</span> <span class="n">parse_failures</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">renew_failures</span> <span class="ow">or</span> <span class="n">parse_failures</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> renew failure(s), </span><span class="si">{1}</span><span class="s2"> parse failure(s)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">renew_failures</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">parse_failures</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;no renewal failures&quot;</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
    <span class="copyright">
    &copy; Copyright 2014-2018 - The Certbot software and documentation are licensed under the Apache 2.0 license as described at <a href="https://eff.org/cb-license">https://eff.org/cb-license</a>.
    </span>
    <br>
    <br>
    <span class="status">
        <a href="https://letsencrypt.status.io/">Let's Encrypt Status</a>
    </span>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Other Versions</span>
      v: 
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Downloads</dt>
        <dd><a href="../../certbot.pdf">PDF</a></dd>
        <dd><a href="../../certbot.zip">HTML</a></dd>
        <dd><a href="../../certbot.epub">Epub</a></dd>
      </dl>
      <hr/>

    </div>
  </div>


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.31.0.dev0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

<noscript><img src="https://anon-stats.eff.org/piwik.php?idsite=24&amp;rec=1&amp;action_name=certbot.renewal%E2%80%94%20Certbot%200.31.0.dev0%20documentation" style="border:0" height="0" width="0" alt="" /></noscript>
<div style="height: 0; width: 0; position: absolute" id="anon-stats"></div>
<script type="text/javascript">
document.getElementById('anon-stats').innerHTML = '<img src="https://anon-stats.eff.org/piwik.php?idsite=24&amp;rec=1&amp;urlref=' + encodeURIComponent(document.referrer) + '&amp;action_name=' + encodeURIComponent(document.title) + '" style="border:0" height="0" width="0" alt="" />';
</script>
</body>
</html>