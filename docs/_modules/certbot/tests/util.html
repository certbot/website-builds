

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>certbot.tests.util &mdash; Certbot 1.16.0.dev0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Certbot
          

          
          </a>

          
            
            
              <div class="version">
                1.16
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../what.html">What is a Certificate?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Get Certbot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../using.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../packaging.html">Packaging Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compatibility.html">Backwards Compatibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../resources.html">Resources</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API Documentation</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Certbot</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>certbot.tests.util</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for certbot.tests.util</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Test utilities.&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">reload</span> <span class="k">as</span> <span class="n">reload_module</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">cryptography.hazmat.backends</span> <span class="kn">import</span> <span class="n">default_backend</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives</span> <span class="kn">import</span> <span class="n">serialization</span>
<span class="kn">import</span> <span class="nn">josepy</span> <span class="k">as</span> <span class="nn">jose</span>
<span class="kn">import</span> <span class="nn">OpenSSL</span>
<span class="kn">import</span> <span class="nn">pkg_resources</span>

<span class="kn">from</span> <span class="nn">certbot</span> <span class="kn">import</span> <span class="n">interfaces</span>
<span class="kn">from</span> <span class="nn">certbot</span> <span class="kn">import</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">certbot._internal</span> <span class="kn">import</span> <span class="n">configuration</span>
<span class="kn">from</span> <span class="nn">certbot._internal</span> <span class="kn">import</span> <span class="n">constants</span>
<span class="kn">from</span> <span class="nn">certbot._internal</span> <span class="kn">import</span> <span class="n">lock</span>
<span class="kn">from</span> <span class="nn">certbot._internal</span> <span class="kn">import</span> <span class="n">storage</span>
<span class="kn">from</span> <span class="nn">certbot.compat</span> <span class="kn">import</span> <span class="n">filesystem</span>
<span class="kn">from</span> <span class="nn">certbot.compat</span> <span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="nn">certbot.display</span> <span class="kn">import</span> <span class="n">util</span> <span class="k">as</span> <span class="n">display_util</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c1"># When we remove this deprecated import, we should also remove the</span>
    <span class="c1"># &quot;external-mock&quot; test environment and the mock dependency listed in</span>
    <span class="c1"># tools/pinning/pyproject.toml.</span>
    <span class="kn">import</span> <span class="nn">mock</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
        <span class="s2">&quot;The external mock module is being used for backwards compatibility &quot;</span>
        <span class="s2">&quot;since it is available, however, future versions of Certbot&#39;s tests will &quot;</span>
        <span class="s2">&quot;use unittest.mock. Be sure to update your code accordingly.&quot;</span><span class="p">,</span>
        <span class="ne">PendingDeprecationWarning</span>
    <span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
    <span class="kn">from</span> <span class="nn">unittest</span> <span class="kn">import</span> <span class="n">mock</span> <span class="c1"># type: ignore</span>



<div class="viewcode-block" id="vector_path"><a class="viewcode-back" href="../../../api/certbot.tests.util.html#certbot.tests.util.vector_path">[docs]</a><span class="k">def</span> <span class="nf">vector_path</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Path to a test vector.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span>
        <span class="vm">__name__</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;testdata&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">names</span><span class="p">))</span></div>


<div class="viewcode-block" id="load_vector"><a class="viewcode-back" href="../../../api/certbot.tests.util.html#certbot.tests.util.load_vector">[docs]</a><span class="k">def</span> <span class="nf">load_vector</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load contents of a test vector.&quot;&quot;&quot;</span>
    <span class="c1"># luckily, resource_string opens file in binary mode</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_string</span><span class="p">(</span>
        <span class="vm">__name__</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;testdata&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">names</span><span class="p">))</span>
    <span class="c1"># Try at most to convert CRLF to LF when data is text</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="c1"># Failed to process the file with standard encoding.</span>
        <span class="c1"># Most likely not a text file, return its bytes untouched.</span>
        <span class="k">return</span> <span class="n">data</span></div>


<span class="k">def</span> <span class="nf">_guess_loader</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">loader_pem</span><span class="p">,</span> <span class="n">loader_der</span><span class="p">):</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;.pem&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">loader_pem</span>
    <span class="k">elif</span> <span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;.der&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">loader_der</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Loader could not be recognized based on extension&quot;</span><span class="p">)</span>  <span class="c1"># pragma: no cover</span>


<div class="viewcode-block" id="load_cert"><a class="viewcode-back" href="../../../api/certbot.tests.util.html#certbot.tests.util.load_cert">[docs]</a><span class="k">def</span> <span class="nf">load_cert</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load certificate.&quot;&quot;&quot;</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">_guess_loader</span><span class="p">(</span>
        <span class="n">names</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_ASN1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">load_certificate</span><span class="p">(</span><span class="n">loader</span><span class="p">,</span> <span class="n">load_vector</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">))</span></div>


<div class="viewcode-block" id="load_csr"><a class="viewcode-back" href="../../../api/certbot.tests.util.html#certbot.tests.util.load_csr">[docs]</a><span class="k">def</span> <span class="nf">load_csr</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load certificate request.&quot;&quot;&quot;</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">_guess_loader</span><span class="p">(</span>
        <span class="n">names</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_ASN1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">load_certificate_request</span><span class="p">(</span><span class="n">loader</span><span class="p">,</span> <span class="n">load_vector</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">))</span></div>


<div class="viewcode-block" id="load_comparable_csr"><a class="viewcode-back" href="../../../api/certbot.tests.util.html#certbot.tests.util.load_comparable_csr">[docs]</a><span class="k">def</span> <span class="nf">load_comparable_csr</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load ComparableX509 certificate request.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jose</span><span class="o">.</span><span class="n">ComparableX509</span><span class="p">(</span><span class="n">load_csr</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">))</span></div>


<div class="viewcode-block" id="load_rsa_private_key"><a class="viewcode-back" href="../../../api/certbot.tests.util.html#certbot.tests.util.load_rsa_private_key">[docs]</a><span class="k">def</span> <span class="nf">load_rsa_private_key</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load RSA private key.&quot;&quot;&quot;</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">_guess_loader</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">serialization</span><span class="o">.</span><span class="n">load_pem_private_key</span><span class="p">,</span>
                           <span class="n">serialization</span><span class="o">.</span><span class="n">load_der_private_key</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jose</span><span class="o">.</span><span class="n">ComparableRSAKey</span><span class="p">(</span><span class="n">loader</span><span class="p">(</span>
        <span class="n">load_vector</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">),</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">()))</span></div>


<div class="viewcode-block" id="load_pyopenssl_private_key"><a class="viewcode-back" href="../../../api/certbot.tests.util.html#certbot.tests.util.load_pyopenssl_private_key">[docs]</a><span class="k">def</span> <span class="nf">load_pyopenssl_private_key</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load pyOpenSSL private key.&quot;&quot;&quot;</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">_guess_loader</span><span class="p">(</span>
        <span class="n">names</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_ASN1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">load_privatekey</span><span class="p">(</span><span class="n">loader</span><span class="p">,</span> <span class="n">load_vector</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">))</span></div>


<div class="viewcode-block" id="make_lineage"><a class="viewcode-back" href="../../../api/certbot.tests.util.html#certbot.tests.util.make_lineage">[docs]</a><span class="k">def</span> <span class="nf">make_lineage</span><span class="p">(</span><span class="n">config_dir</span><span class="p">,</span> <span class="n">testfile</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a lineage defined by testfile.</span>

<span class="sd">    This creates the archive, live, and renewal directories if</span>
<span class="sd">    necessary and creates a simple lineage.</span>

<span class="sd">    :param str config_dir: path to the configuration directory</span>
<span class="sd">    :param str testfile: configuration file to base the lineage on</span>

<span class="sd">    :returns: path to the renewal conf file for the created lineage</span>
<span class="sd">    :rtype: str</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lineage_name</span> <span class="o">=</span> <span class="n">testfile</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;.conf&#39;</span><span class="p">)]</span>

    <span class="n">conf_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">config_dir</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">RENEWAL_CONFIGS_DIR</span><span class="p">)</span>
    <span class="n">archive_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">config_dir</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">ARCHIVE_DIR</span><span class="p">,</span> <span class="n">lineage_name</span><span class="p">)</span>
    <span class="n">live_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">config_dir</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">LIVE_DIR</span><span class="p">,</span> <span class="n">lineage_name</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">directory</span> <span class="ow">in</span> <span class="p">(</span><span class="n">archive_dir</span><span class="p">,</span> <span class="n">conf_dir</span><span class="p">,</span> <span class="n">live_dir</span><span class="p">,):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
            <span class="n">filesystem</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

    <span class="n">sample_archive</span> <span class="o">=</span> <span class="n">vector_path</span><span class="p">(</span><span class="s1">&#39;sample-archive</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;-ec&#39;</span> <span class="k">if</span> <span class="n">ec</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">kind</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">sample_archive</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sample_archive</span><span class="p">,</span> <span class="n">kind</span><span class="p">),</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">,</span> <span class="n">kind</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">kind</span> <span class="ow">in</span> <span class="n">storage</span><span class="o">.</span><span class="n">ALL_FOUR</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">1.pem&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kind</span><span class="p">)),</span>
                   <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">live_dir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">.pem&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kind</span><span class="p">)))</span>

    <span class="n">conf_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_dir</span><span class="p">,</span> <span class="n">conf_dir</span><span class="p">,</span> <span class="n">testfile</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">vector_path</span><span class="p">(</span><span class="n">testfile</span><span class="p">))</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">conf_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span>
                <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MAGICDIR&#39;</span><span class="p">,</span> <span class="n">config_dir</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">src</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">conf_path</span></div>


<div class="viewcode-block" id="patch_get_utility"><a class="viewcode-back" href="../../../api/certbot.tests.util.html#certbot.tests.util.patch_get_utility">[docs]</a><span class="k">def</span> <span class="nf">patch_get_utility</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="s1">&#39;zope.component.getUtility&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Patch zope.component.getUtility to use a special mock IDisplay.</span>

<span class="sd">    The mock IDisplay works like a regular mock object, except it also</span>
<span class="sd">    also asserts that methods are called with valid arguments.</span>

<span class="sd">    :param str target: path to patch</span>

<span class="sd">    :returns: mock zope.component.getUtility</span>
<span class="sd">    :rtype: mock.MagicMock</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">new_callable</span><span class="o">=</span><span class="n">_create_get_utility_mock</span><span class="p">)</span></div>


<div class="viewcode-block" id="patch_get_utility_with_stdout"><a class="viewcode-back" href="../../../api/certbot.tests.util.html#certbot.tests.util.patch_get_utility_with_stdout">[docs]</a><span class="k">def</span> <span class="nf">patch_get_utility_with_stdout</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="s1">&#39;zope.component.getUtility&#39;</span><span class="p">,</span>
                                  <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Patch zope.component.getUtility to use a special mock IDisplay.</span>

<span class="sd">    The mock IDisplay works like a regular mock object, except it also</span>
<span class="sd">    also asserts that methods are called with valid arguments.</span>

<span class="sd">    The `message` argument passed to the IDisplay methods is passed to</span>
<span class="sd">    stdout&#39;s write method.</span>

<span class="sd">    :param str target: path to patch</span>
<span class="sd">    :param object stdout: object to write standard output to; it is</span>
<span class="sd">        expected to have a `write` method</span>

<span class="sd">    :returns: mock zope.component.getUtility</span>
<span class="sd">    :rtype: mock.MagicMock</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span> <span class="k">if</span> <span class="n">stdout</span> <span class="k">else</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>

    <span class="n">freezable_mock</span> <span class="o">=</span> <span class="n">_create_get_utility_mock_with_stdout</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">freezable_mock</span><span class="p">)</span></div>


<div class="viewcode-block" id="FreezableMock"><a class="viewcode-back" href="../../../api/certbot.tests.util.html#certbot.tests.util.FreezableMock">[docs]</a><span class="k">class</span> <span class="nc">FreezableMock</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Mock object with the ability to freeze attributes.</span>

<span class="sd">    This class works like a regular mock.MagicMock object, except</span>
<span class="sd">    attributes and behavior set before the object is frozen cannot</span>
<span class="sd">    be changed during tests.</span>

<span class="sd">    If a func argument is provided to the constructor, this function</span>
<span class="sd">    is called first when an instance of FreezableMock is called,</span>
<span class="sd">    followed by the usual behavior defined by MagicMock. The return</span>
<span class="sd">    value of func is ignored.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frozen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">sentinel</span><span class="o">.</span><span class="n">DEFAULT</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frozen_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span> <span class="k">if</span> <span class="n">frozen</span> <span class="k">else</span> <span class="p">{</span><span class="s1">&#39;freeze&#39;</span><span class="p">,</span> <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mock</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">return_value</span> <span class="o">!=</span> <span class="n">mock</span><span class="o">.</span><span class="n">sentinel</span><span class="o">.</span><span class="n">DEFAULT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">return_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frozen</span> <span class="o">=</span> <span class="n">frozen</span>

<div class="viewcode-block" id="FreezableMock.freeze"><a class="viewcode-back" href="../../../api/certbot.tests.util.html#certbot.tests.util.FreezableMock.freeze">[docs]</a>    <span class="k">def</span> <span class="nf">freeze</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Freeze object preventing further changes.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frozen</span> <span class="o">=</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mock</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;_frozen&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;return_value&#39;</span><span class="p">,</span> <span class="s1">&#39;side_effect&#39;</span><span class="p">,):</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">object</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_mock&#39;</span><span class="p">),</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;_frozen_set&#39;</span> <span class="ow">or</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frozen_set</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">object</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_mock&#39;</span><span class="p">),</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Before it is frozen, attributes are set on the FreezableMock</span>
<span class="sd">        instance and added to the _frozen_set. Attributes in the _frozen_set</span>
<span class="sd">        cannot be changed after the FreezableMock is frozen. In this case,</span>
<span class="sd">        they are set on the underlying _mock.</span>

<span class="sd">        In cases of return_value and side_effect, these attributes are always</span>
<span class="sd">        passed through to the instance&#39;s _mock and added to the _frozen_set</span>
<span class="sd">        before the object is frozen.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frozen</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frozen_set</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Cannot change frozen attribute &#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mock</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;_frozen_set&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_frozen_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;return_value&#39;</span><span class="p">,</span> <span class="s1">&#39;side_effect&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mock</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_create_get_utility_mock</span><span class="p">():</span>
    <span class="n">display</span> <span class="o">=</span> <span class="n">FreezableMock</span><span class="p">()</span>
    <span class="c1"># Use pylint code for disable to keep on single line under line length limit</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">interfaces</span><span class="o">.</span><span class="n">IDisplay</span><span class="o">.</span><span class="n">names</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;notification&#39;</span><span class="p">:</span>
            <span class="n">frozen_mock</span> <span class="o">=</span> <span class="n">FreezableMock</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">_assert_valid_call</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">frozen_mock</span><span class="p">)</span>
    <span class="n">display</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">FreezableMock</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">display</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_create_get_utility_mock_with_stdout</span><span class="p">(</span><span class="n">stdout</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_write_msg</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="o">*</span><span class="n">unused_args</span><span class="p">,</span> <span class="o">**</span><span class="n">unused_kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write to message to stdout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">message</span><span class="p">:</span>
            <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">mock_method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mock function for IDisplay methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_assert_valid_call</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="n">_write_msg</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


    <span class="n">display</span> <span class="o">=</span> <span class="n">FreezableMock</span><span class="p">()</span>
    <span class="c1"># Use pylint code for disable to keep on single line under line length limit</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">interfaces</span><span class="o">.</span><span class="n">IDisplay</span><span class="o">.</span><span class="n">names</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;notification&#39;</span><span class="p">:</span>
            <span class="n">frozen_mock</span> <span class="o">=</span> <span class="n">FreezableMock</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">func</span><span class="o">=</span><span class="n">_write_msg</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">frozen_mock</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">frozen_mock</span> <span class="o">=</span> <span class="n">FreezableMock</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">func</span><span class="o">=</span><span class="n">mock_method</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">frozen_mock</span><span class="p">)</span>
    <span class="n">display</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">FreezableMock</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">display</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_assert_valid_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">assert_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]]</span>

    <span class="n">assert_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">assert_kwargs</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">assert_kwargs</span><span class="p">[</span><span class="s1">&#39;cli_flag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cli_flag&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">assert_kwargs</span><span class="p">[</span><span class="s1">&#39;force_interactive&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;force_interactive&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">display_util</span><span class="o">.</span><span class="n">assert_valid_call</span><span class="p">(</span><span class="o">*</span><span class="n">assert_args</span><span class="p">,</span> <span class="o">**</span><span class="n">assert_kwargs</span><span class="p">)</span>


<div class="viewcode-block" id="TempDirTestCase"><a class="viewcode-back" href="../../../api/certbot.tests.util.html#certbot.tests.util.TempDirTestCase">[docs]</a><span class="k">class</span> <span class="nc">TempDirTestCase</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base test class which sets up and tears down a temporary directory&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TempDirTestCase.setUp"><a class="viewcode-back" href="../../../api/certbot.tests.util.html#certbot.tests.util.TempDirTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute before test&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span></div>

<div class="viewcode-block" id="TempDirTestCase.tearDown"><a class="viewcode-back" href="../../../api/certbot.tests.util.html#certbot.tests.util.TempDirTestCase.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute after test&quot;&quot;&quot;</span>
        <span class="c1"># Cleanup opened resources after a test. This is usually done through atexit handlers in</span>
        <span class="c1"># Certbot, but during tests, atexit will not run registered functions before tearDown is</span>
        <span class="c1"># called and instead will run them right before the entire test process exits.</span>
        <span class="c1"># It is a problem on Windows, that does not accept to clean resources before closing them.</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="c1"># Remove logging handlers that have been closed so they won&#39;t be</span>
        <span class="c1"># accidentally used in future tests.</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">util</span><span class="o">.</span><span class="n">_release_locks</span><span class="p">()</span>  <span class="c1"># pylint: disable=protected-access</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ConfigTestCase"><a class="viewcode-back" href="../../../api/certbot.tests.util.html#certbot.tests.util.ConfigTestCase">[docs]</a><span class="k">class</span> <span class="nc">ConfigTestCase</span><span class="p">(</span><span class="n">TempDirTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test class which sets up a NamespaceConfig object.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="ConfigTestCase.setUp"><a class="viewcode-back" href="../../../api/certbot.tests.util.html#certbot.tests.util.ConfigTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">NamespaceConfig</span><span class="p">(</span>
            <span class="n">mock</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">(</span><span class="o">**</span><span class="n">constants</span><span class="o">.</span><span class="n">CLI_DEFAULTS</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">verb</span> <span class="o">=</span> <span class="s2">&quot;certonly&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">config_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">work_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="p">,</span> <span class="s1">&#39;work&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">logs_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="p">,</span> <span class="s1">&#39;logs&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cert_path</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">CLI_DEFAULTS</span><span class="p">[</span><span class="s1">&#39;auth_cert_path&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">fullchain_path</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">CLI_DEFAULTS</span><span class="p">[</span><span class="s1">&#39;auth_chain_path&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">chain_path</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">CLI_DEFAULTS</span><span class="p">[</span><span class="s1">&#39;auth_chain_path&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="s2">&quot;https://example.com&quot;</span></div></div>


<span class="k">def</span> <span class="nf">_handle_lock</span><span class="p">(</span><span class="n">event_in</span><span class="p">,</span> <span class="n">event_out</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Acquire a file lock on given path, then wait to release it. This worker is coordinated</span>
<span class="sd">    using events to signal when the lock should be acquired and released.</span>
<span class="sd">    :param multiprocessing.Event event_in: event object to signal when to release the lock</span>
<span class="sd">    :param multiprocessing.Event event_out: event object to signal when the lock is acquired</span>
<span class="sd">    :param path: the path to lock</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">my_lock</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="n">lock_dir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">my_lock</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="n">LockFile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">event_out</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">event_in</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">),</span> <span class="s1">&#39;Timeout while waiting to release the lock.&#39;</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">my_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>


<div class="viewcode-block" id="lock_and_call"><a class="viewcode-back" href="../../../api/certbot.tests.util.html#certbot.tests.util.lock_and_call">[docs]</a><span class="k">def</span> <span class="nf">lock_and_call</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">path_to_lock</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Grab a lock on path_to_lock from a foreign process then execute the callback.</span>
<span class="sd">    :param callable callback: object to call after acquiring the lock</span>
<span class="sd">    :param str path_to_lock: path to file or directory to lock</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Reload certbot.util module to reset internal _LOCKS dictionary.</span>
    <span class="n">reload_module</span><span class="p">(</span><span class="n">util</span><span class="p">)</span>

    <span class="n">emit_event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
    <span class="n">receive_event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
    <span class="n">process</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_handle_lock</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">emit_event</span><span class="p">,</span> <span class="n">receive_event</span><span class="p">,</span> <span class="n">path_to_lock</span><span class="p">))</span>
    <span class="n">process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># Wait confirmation that lock is acquired</span>
    <span class="k">assert</span> <span class="n">receive_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span> <span class="s1">&#39;Timeout while waiting to acquire the lock.&#39;</span>
    <span class="c1"># Execute the callback</span>
    <span class="n">callback</span><span class="p">()</span>
    <span class="c1"># Trigger unlock from foreign process</span>
    <span class="n">emit_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

    <span class="c1"># Wait for process termination</span>
    <span class="n">process</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">process</span><span class="o">.</span><span class="n">exitcode</span> <span class="o">==</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="skip_on_windows"><a class="viewcode-back" href="../../../api/certbot.tests.util.html#certbot.tests.util.skip_on_windows">[docs]</a><span class="k">def</span> <span class="nf">skip_on_windows</span><span class="p">(</span><span class="n">reason</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator to skip permanently a test on Windows. A reason is required.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wrapped version&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skipIf</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;win32&#39;</span><span class="p">,</span> <span class="n">reason</span><span class="p">)(</span><span class="n">function</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span></div>


<div class="viewcode-block" id="temp_join"><a class="viewcode-back" href="../../../api/certbot.tests.util.html#certbot.tests.util.temp_join">[docs]</a><span class="k">def</span> <span class="nf">temp_join</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the given path joined to the tempdir path for the current platform</span>
<span class="sd">    Eg.: &#39;cert&#39; =&gt; /tmp/cert (Linux) or &#39;C:\\Users\\currentuser\\AppData\\Temp\\cert&#39; (Windows)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">(),</span> <span class="n">path</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
    <span class="copyright">
    &copy; Copyright 2014-2018 - The Certbot software and documentation are licensed under the Apache 2.0 license as described at <a href="https://eff.org/cb-license">https://eff.org/cb-license</a>.
    </span>
    <br>
    <br>
    <span class="status">
        <a href="https://letsencrypt.status.io/">Let's Encrypt Status</a>
    </span>

    </p>
  </div>
  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>